'use client';\n\nimport { useState, useEffect } from 'react';\nimport { MainLayout } from '@/components/layout/MainLayout';\nimport { ProtectedRoute } from '@/components/auth/ProtectedRoute';\nimport { LoadingWrapper } from '@/components/ui/loading-wrapper';\nimport { Card, CardContent } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { PrescriptionCard } from '@/components/prescriptions/PrescriptionCard';\nimport { PrescriptionFormModal } from '@/components/prescriptions/PrescriptionFormModal';\nimport { PrescriptionDetailModal } from '@/components/prescriptions/PrescriptionDetailModal';\nimport { Search, Pill, RefreshCw, AlertCircle, CheckCircle, Plus } from 'lucide-react';\nimport { Prescription } from '@/types';\nimport { mockPrescriptions } from '@/data/mockData';\nimport { toast } from '@/components/ui/use-toast';\n\nexport default function PrescriptionsPage() {\n  const [isLoading, setIsLoading] = useState(true);\n  const [search, setSearch] = useState('');\n  const [statusFilter, setStatusFilter] = useState<'all' | 'active' | 'completed' | 'cancelled'>('all');\n  const [prescriptions, setPrescriptions] = useState<Prescription[]>(mockPrescriptions);\n  const [isFormModalOpen, setIsFormModalOpen] = useState(false);\n  const [isDetailModalOpen, setIsDetailModalOpen] = useState(false);\n  const [selectedPrescription, setSelectedPrescription] = useState<Prescription | null>(null);\n  const [editingPrescription, setEditingPrescription] = useState<Prescription | undefined>(undefined);\n\n  useEffect(() => {\n    const timer = setTimeout(() => setIsLoading(false), 1000);\n    return () => clearTimeout(timer);\n  }, []);\n\n  const filteredPrescriptions = prescriptions.filter(p => {\n    const matchesSearch = p.petName.toLowerCase().includes(search.toLowerCase()) ||\n      p.medicationName.toLowerCase().includes(search.toLowerCase()) ||\n      p.veterinarianName.toLowerCase().includes(search.toLowerCase());\n    const matchesStatus = statusFilter === 'all' || p.status === statusFilter;\n    return matchesSearch && matchesStatus;\n  });\n\n  const activeCount = prescriptions.filter(p => p.status === 'active').length;\n  const needRefillCount = prescriptions.filter(p => p.status === 'active' && p.refillsRemaining <= 1).length;\n\n  const handleCreatePrescription = () => {\n    setEditingPrescription(undefined);\n    setIsFormModalOpen(true);\n  };\n\n  const handleEditPrescription = (prescription: Prescription) => {\n    setEditingPrescription(prescription);\n    setIsFormModalOpen(true);\n  };\n\n  const handleViewPrescription = (prescription: Prescription) => {\n    setSelectedPrescription(prescription);\n    setIsDetailModalOpen(true);\n  };\n\n  const handleSavePrescription = (prescriptionData: Omit<Prescription, 'id'>) => {\n    if (editingPrescription) {\n      setPrescriptions(prev => prev.map(p => \n        p.id === editingPrescription.id \n          ? { ...prescriptionData, id: editingPrescription.id }\n          : p\n      ));\n      toast({\n        title: \"Prescription Updated\",\n        description: \"The prescription has been successfully updated.\"\n      });\n    } else {\n      const newPrescription: Prescription = {\n        ...prescriptionData,\n        id: `rx-${Date.now()}`\n      };\n      setPrescriptions(prev => [newPrescription, ...prev]);\n      toast({\n        title: \"Prescription Created\",\n        description: \"New prescription has been successfully created.\"\n      });\n    }\n  };\n\n  const handleRefill = (prescription: Prescription) => {\n    if (prescription.refillsRemaining > 0) {\n      setPrescriptions(prev => prev.map(p => \n        p.id === prescription.id \n          ? { ...p, refillsRemaining: p.refillsRemaining - 1 }\n          : p\n      ));\n      toast({\n        title: \"Refill Processed\",\n        description: `Refill processed for ${prescription.medicationName}. ${prescription.refillsRemaining - 1} refills remaining.`\n      });\n    }\n  };\n\n  const handleEditFromDetail = () => {\n    if (selectedPrescription) {\n      setIsDetailModalOpen(false);\n      handleEditPrescription(selectedPrescription);\n    }\n  };\n\n  const handleRefillFromDetail = () => {\n    if (selectedPrescription) {\n      handleRefill(selectedPrescription);\n      setSelectedPrescription(prev => prev ? {\n        ...prev,\n        refillsRemaining: prev.refillsRemaining - 1\n      } : null);\n    }\n  };\n\n  return (\n    <ProtectedRoute requiredPermissions={['prescriptions', 'records']}>\n      <MainLayout\n        title=\"Prescription Management\"\n        subtitle={`${prescriptions.length} prescriptions • ${activeCount} active • ${needRefillCount} need refill`}\n        action={{ label: 'New Prescription', onClick: handleCreatePrescription }}\n      >\n        <LoadingWrapper isLoading={isLoading} variant=\"list\">\n          <div className=\"space-y-6\">\n            {/* Stats */}\n            <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n              <Card>\n                <CardContent className=\"p-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <p className=\"text-sm font-medium text-muted-foreground\">Total Prescriptions</p>\n                      <p className=\"text-2xl font-bold\">{prescriptions.length}</p>\n                    </div>\n                    <Pill className=\"h-8 w-8 text-primary\" />\n                  </div>\n                </CardContent>\n              </Card>\n              <Card>\n                <CardContent className=\"p-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <p className=\"text-sm font-medium text-muted-foreground\">Active</p>\n                      <p className=\"text-2xl font-bold text-success\">{activeCount}</p>\n                    </div>\n                    <CheckCircle className=\"h-8 w-8 text-success\" />\n                  </div>\n                </CardContent>\n              </Card>\n              <Card>\n                <CardContent className=\"p-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <p className=\"text-sm font-medium text-muted-foreground\">Need Refill</p>\n                      <p className=\"text-2xl font-bold text-warning\">{needRefillCount}</p>\n                    </div>\n                    <RefreshCw className=\"h-8 w-8 text-warning\" />\n                  </div>\n                </CardContent>\n              </Card>\n              <Card>\n                <CardContent className=\"p-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <p className=\"text-sm font-medium text-muted-foreground\">Completed</p>\n                      <p className=\"text-2xl font-bold\">{prescriptions.filter(p => p.status === 'completed').length}</p>\n                    </div>\n                    <AlertCircle className=\"h-8 w-8 text-muted-foreground\" />\n                  </div>\n                </CardContent>\n              </Card>\n            </div>\n\n            {/* Filters */}\n            <div className=\"flex gap-4\">\n              <div className=\"relative flex-1 max-w-md\">\n                <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n                <Input\n                  placeholder=\"Search prescriptions...\"\n                  value={search}\n                  onChange={(e) => setSearch(e.target.value)}\n                  className=\"pl-10\"\n                />\n              </div>\n              <div className=\"flex gap-2\">\n                {(['all', 'active', 'completed', 'cancelled'] as const).map((status) => (\n                  <Button\n                    key={status}\n                    variant={statusFilter === status ? 'default' : 'outline'}\n                    size=\"sm\"\n                    onClick={() => setStatusFilter(status)}\n                    className=\"capitalize\"\n                  >\n                    {status}\n                  </Button>\n                ))}\n              </div>\n            </div>\n\n            {/* Prescriptions List */}\n            <div className=\"space-y-4\">\n              {filteredPrescriptions.length === 0 ? (\n                <Card>\n                  <CardContent className=\"p-12 text-center\">\n                    <Pill className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n                    <h3 className=\"text-lg font-semibold mb-2\">No prescriptions found</h3>\n                    <p className=\"text-muted-foreground mb-4\">\n                      {search || statusFilter !== 'all' \n                        ? 'Try adjusting your search or filters'\n                        : 'Get started by creating your first prescription'\n                      }\n                    </p>\n                    {!search && statusFilter === 'all' && (\n                      <Button onClick={handleCreatePrescription}>\n                        <Plus className=\"h-4 w-4 mr-2\" />\n                        Create Prescription\n                      </Button>\n                    )}\n                  </CardContent>\n                </Card>\n              ) : (\n                filteredPrescriptions.map((prescription) => (\n                  <PrescriptionCard\n                    key={prescription.id}\n                    prescription={prescription}\n                    onView={() => handleViewPrescription(prescription)}\n                    onEdit={() => handleEditPrescription(prescription)}\n                    onRefill={() => handleRefill(prescription)}\n                  />\n                ))\n              )}\n            </div>\n          </div>\n        </LoadingWrapper>\n\n        {/* Modals */}\n        <PrescriptionFormModal\n          isOpen={isFormModalOpen}\n          onClose={() => setIsFormModalOpen(false)}\n          onSave={handleSavePrescription}\n          prescription={editingPrescription}\n        />\n\n        <PrescriptionDetailModal\n          isOpen={isDetailModalOpen}\n          onClose={() => setIsDetailModalOpen(false)}\n          prescription={selectedPrescription}\n          onEdit={handleEditFromDetail}\n          onRefill={handleRefillFromDetail}\n        />\n      </MainLayout>\n    </ProtectedRoute>\n  );\n}